### èƒŒæ™¯

> é¡¹ç›®æ¥å…¥å¾®ä¿¡å°ç¨‹åºæ¶ˆæ¯ï¼Œä¸æƒ³ä¸€ä¸ªä¸€ä¸ªæ¥å…¥å¾®ä¿¡çš„apiï¼Œæ‰¾äº†ä¸ªç”¨å¾®ä¿¡apiå°è£…çš„sdk, [https://github.com/Wechat-Group/WxJava](https://github.com/Wechat-Group/WxJava), ä½†è¿™ä¸ªsdkåœ¨å¤„ç†å¼‚å¸¸æ—¶ï¼Œ è‡ªå·±å…ˆlogäº†å¼‚å¸¸ï¼Œç„¶åå†æŠ›å‡ºå¼‚å¸¸ã€‚ 

1. æœ‰çš„å¼‚å¸¸æˆ‘ä»¬åœ¨ä¸šåŠ¡å±‚æ˜¯å¤„ç†è¿‡çš„ï¼ˆæ¯”å¦‚ç»™ç”¨æˆ·æ¨é€æé†’æ¶ˆæ¯ï¼Œç”¨æˆ·æ‹’æ”¶äº†ï¼Œè°ƒç”¨å¾®ä¿¡æ¥å£æ—¶å¾®ä¿¡è¿”å›äº†å¼‚å¸¸ï¼‰
2. è¿™äº›å¼‚å¸¸ä¸šåŠ¡å±‚å·²ç»å¤„ç†è¿‡äº†ï¼Œ ä½†æ˜¯è¿™ä¸ªsdkä»ç„¶ log äº†error
3. æˆ‘ä»¬ç³»ç»Ÿæœ‰æ ¹æ®errorå¼‚å¸¸æ•°å‘Šè­¦ï¼Œè¿™äº›å¼‚å¸¸ç»å¸¸è¯¯è§¦å‘å‘Šè­¦ï¼Œé€ æˆå¹²æ‰°

```xml
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-miniapp</artifactId>
    <version>4.1.9.B</version>
</dependency>
```


### å¤„ç†æ–¹æ³•

> è¿™ä¸ªsdkçš„å¼‚å¸¸å¤„ç†æ–¹å¼æœ‰äº›ä¸åˆé€‚ï¼Œ ä½†æ˜¯ä¹Ÿæ²¡æ³•å¿«é€Ÿä¿®æ”¹å®ƒçš„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•ç»•è¿‡

1. æ’æŸ¥ä»£ç å‘ç°å®ƒçš„log æ˜¯é€šè¿‡ sl4j å†™å…¥çš„ï¼Œæˆ‘ä»¬é¡¹ç›®é‡‡ç”¨çš„æ˜¯ log4j2 (å°±æ˜¯21å¹´åº•é‚£ä¸ªç–¯ç‹‚RCEæ¼æ´çš„log libğŸ˜…)

```java
package cn.binarywang.wx.miniapp.api.impl;
@Slf4j
public abstract class BaseWxMaServiceImpl<H, P> implements WxMaService, RequestHttp<H, P> {
private <T, E> T executeInternal(RequestExecutor<T, E> executor, 
    String uri, E data, boolean doNotAutoRefreshToken) throws WxErrorException {
    // çœç•¥....
    try {
      T result = executor.execute(uriWithAccessToken, data, WxType.MiniApp);
      log.debug("\nã€è¯·æ±‚åœ°å€ã€‘: {}\nã€è¯·æ±‚å‚æ•°ã€‘ï¼š{}\nã€å“åº”æ•°æ®ã€‘ï¼š{}", uriWithAccessToken, dataForLog, result);
      return result;
    } catch (WxErrorException e) {
      if (error.getErrorCode() != 0) {
        log.error("\nã€è¯·æ±‚åœ°å€ã€‘: {}\nã€è¯·æ±‚å‚æ•°ã€‘ï¼š{}\nã€é”™è¯¯ä¿¡æ¯ã€‘ï¼š{}", uriWithAccessToken, dataForLog, error);
        throw new WxErrorException(error, e);
      }
      return null;
    } catch (IOException e) {
      log.error("\nã€è¯·æ±‚åœ°å€ã€‘: {}\nã€è¯·æ±‚å‚æ•°ã€‘ï¼š{}\nã€å¼‚å¸¸ä¿¡æ¯ã€‘ï¼š{}", uriWithAccessToken, dataForLog, e.getMessage());
      throw new WxRuntimeException(e);
    }
  }
}
```

2. æŸ¥çœ‹ log4j çš„æ–‡æ¡£ï¼Œ å‘ç°å¯ä»¥é€šè¿‡ filter æ¥è¿‡æ»¤log, ä¿®æ”¹ `log4j2.xml` é…ç½® 

```xml
<Loggers>
    <Logger name="cn.binarywang.wx.miniapp.api.impl.BaseWxMaServiceImpl" level="info" additivity="false">
        <StringMatchFilter text="è¯·æ±‚åœ°å€" onMatch="DENY" onMismatch="ACCEPT"/>
        <AppenderRef ref="File"/>
    </Logger>
    <Root level="info">
        <AppenderRef ref="File"/>
    </Root>
</Loggers>
```

å‚è€ƒ:

- https://logging.apache.org/log4j/2.x/manual/architecture.html
- https://logging.apache.org/log4j/2.x/manual/configuration.html
- https://logging.apache.org/log4j/2.x/manual/customloglevels.html
- https://logging.apache.org/log4j/log4j-2.2/manual/filters.html#RegexFilter
- https://www.docs4dev.com/docs/zh/log4j2/2.x/all/manual-filters.html#RegexFilter
- https://blog.csdn.net/justry_deng/article/details/109413153  ï¼ˆå®˜ç½‘æ–‡æ¡£é‡Œå¹¶æ²¡æœ‰ä»‹ç»æ‰€æœ‰å†…ç½®çš„filterï¼Œè¿™é‡Œæœ‰ä»‹ç»ï¼‰

